#!/usr/bin/env bash

# https://s3.amazonaws.com/julialang/bin/osx/x64/0.5/julia-0.5.0-osx10.7+.dmg

install_julia(){
    local install_type=$1
    local version=$2
    local install_path=$3

    local version_trim=${version%.*}
    local tmp_download_dir="$(mktemp -d -t asdf-julia.XXX)"
    if [[ "$(uname)" == "Darwin" ]]; then 
        if [ "$CI_SERVER" = "yes"]; then
            local mountpath="/Volumes/Julia";
            local appname="/Julia.app";
        else
            local mountpath="/Volumes/Julia-$version";
            local appname="/Julia-$version_trim.app";
        fi
        local url="https://julialang.s3.amazonaws.com/bin/osx/x64/$version_trim/julia-$version-osx10.7+.dmg"
        curl $url --create-dirs -so "$tmp_download_dir/julia.dmg"
        hdiutil mount "$tmp_download_dir/julia.dmg"
        cp -R "$mountpath/$appname/Contents/Resources/julia" $install_path
        hdiutil unmount $mountpath
        exit;
    fi 
    local url="https://julialang.s3.amazonaws.com/bin/linux/x64/$version_trim/julia-$version-linux-x86_64.tar.gz"
    curl $url --create-dirs -so "$tmp_download_dir/julia.tar.gz"        
    local output_dir="$(tar -xvf "$tmp_download_dir/julia.tar.gz" -C "$install_path")"
    local install_dir="$(echo $output_dir | cut -f1 -d"/")"
    local julia_dir=${install_dir%-*}
    mv $install_path/$install_dir $install_path/$julia_dir
    rm -rf $tmp_download_dir
}
install_julia $ASDF_INSTALL_TYPE $ASDF_INSTALL_VERSION $ASDF_INSTALL_PATH
